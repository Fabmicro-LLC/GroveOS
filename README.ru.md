# GroveOS - однонитевая событийная операционная система для микроконтроллеров на базе ARM Cortex-M4F 

Цели создания данной ОС:

1. По возможности наиболее полно абстрагировать разработчика от аппаратуры, её инициализации и выполнения сложных процессов взаимодействия с аппаратурой, основанных на прерываниях и ПДП (DMA) с целью упростить процесс разработки приложений для "голого железа".
2. Минимизировать зависимости о сторонних библиотек работы с аппаратрурой.
3. Разрешить проблему лицензионной чистоты: весь код библиотек от сторонних разработчиков (в том числе покрываемый лицензией GPL) остается частью операционной системы, но не приложения. Это позволяет разарабатывать лицензионно-чистые приложения и распространять их в виде бинарных файлов.
4. Упростить загрузку и обновление приложений на аппаратуру: разработчики приложений могут распространять их в виде ELF файлов вместе с сопутсвующими файлами ресурсов и/или конфигурационных файлов. Загрузка обновленных файлов (приложений) осуществляется через последовательный порт по протоколу ZMODEM, при этом старые версии файлов остаются (не удаляются) в файловой системе устройства, что поволяет "откатиться" на предидущую версию в случае неудачного обновления. Получение данных обратно с файловой системы устройства не возможно.

## Поддерживаемые платформы 

* На данный момент поддерживаются только микроконтроллеры про-ва STmicro серии STM32F4xx.
* Ведется работа над поддержкой микроконтроллеров про-ва GigaDevice серии GD32F4xx.

## Основные возможности:

* Однонитевой API основанный на событиях. Обращения к операционной системе производится через вызов/инструкция SVC. Приложения (модули) представляют собой стандартные ELF32 файлы собранные для ОС GroveOS.
* Интерфейс командной строки позволяет настраивать периферийные устройства, просматривать их состояние, передавать и читать данные. Поддерживается следующая аппаратура: GPIO, PWM, ADC, UART, SPI.
* Простой скриптовый язык на основе команд оболочки. Система распознает наличие файла AUTOEXEC.BAT и исполняет его при загрузке - в этом файле могут производится дополнительныые настройки периферии специфичные для данного приложения.
* Крохотная файловая система "Tiny File System" (TFS) позволяет сохранять файлы на встроенной NAND flash. Файлы никогда не удалаются, а только помечаются как "удаленные". При полном заполнении flash необходимо выполнить её форматирование командой "FORMAT".
* Поддержка протокода ZMODEM для загрузки файлов в TFS через последовательный порт. Считывание файлов невозможно по соображениям защитыинформации и кода программ. 
* Системные настройки периферии могут быть сохранены в специально отведенную область NAND Flash, после чего они будут загружаться и устанавливаться каждый раз при перезагрузку (сбросе) устройства.
* Устанавливаемые пользователем (приложением) переменные окружения сохраняются в энергозависимую память подпитываемую батареей (battery-backup memory block).
* Встроенная поддержка протокола Modbus/RTU поддерживает режимы "мастер" и "слейв".
* Встроенная поддержка протокола DALI в режиме "мастер".
* Поддержка SPI LCD дисплеев серии FT800 с наэкранной сенсорной панелью.
* Поддержка OLED дисплеев Winstar.
* Графический интерфейс пользователя позволяет отображать: "окна", "кнопки", поля ввода текста и чисел с помощью наэкранной клавиатуры.


## Зависимости:

1. Кросс-компилятор: GNU C Toolchain 4.7 для архитектуры ARM32 (gcc-arm-none-eabi-4_7-2013q3).
2. HAL библиотеки от STmicro для STM32: CMSIS, STM32F4xx_StdPeriph_Driver, STM32_USB_HOST_Library.
 

## Сборка GroveOS

1. Установить GCC кросс-компилятор для ARM32 (bare-metal), доступен на сайте:  https://developer.arm.com/Tools%20and%20Software/GNU%20Toolchain

2. Установить HAL библиотеки для STM32, доступны из репозитория: https://github.com/Fabmicro-LLC/STM32Libraries.git

3. Изменить путь к кросс-компилятору и библиотекам в ```Makefile``` в соответствии.

4. Сделать копию файла описания аппаратуры ```hardware.h```, привести его в соответствие с вашей аппаратурой. Используйте в качестве примера ```hardware_aps.h``` или ```hardware_grovex.h```.

5. Добавить свою цель (target) в сборочный файл ```Makefile``` которая будет подключать созданный Вами вариант hardware.h. В качестве примера смотрите цели 'aps' или 'grovex'.

6. Выполнить команду ```make <your_target>```.

7. Результирующий бинарный файл ```main.hex``` будет содержать готовую прошивку для МК, которую можно загружить в устройство с помощью проприетарной утилиты ```ST-Link``` или свободной утилиты ```stm32flash```:

	```stm32flash -w main.hex -v -b 115200 /dev/ttyUSB0```

8. Запустить терминал (```minocom```, ```cu``` или ```hyperterm.exe```) и подключить его к устройству по последовательному порту используя параметры: 115200 8N1, выполнить цикл сброса питания и наблюдать процесс загрузки. После успешной загрузки, которая занимает 5-7 секунд (из которых 3 секунды отводится на обнаружение присутствия ZMODEM-а и еще две на ожидания от пользователя сигнала прерывания процесса автозагрузки: ###), операционная система GroveOS предоставит командную строку.

9. Используйте команду ```HELP``` что бы получить список доступных команд и их формат.


## Пример приложения 

Пример модуля (приложения) для операционной системы GroveOS находится в подкаталоге ```GroveOS_Module_Monitor/```, прочтите соответствующий README.


